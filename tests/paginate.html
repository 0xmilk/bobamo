<html>
<head>
    <title>Paginate Test Pad</title>
    <style type="text/css">
        .paginate {
            width: 300px;
            float: left;
            margin-right: 40px;
        }

        .page_navigation .page_link {
            display: inline-block;
            margin: 0 2px;
        }

        .page_navigation .page_link.active {
            font-weight: bold;
        }
    </style>
    <link rel="stylesheet" href="../public/js/libs/bootstrap/css/bootstrap.css">
    <script type="text/javascript" src="../public/js/libs/require/require-jquery.js"></script>
    <script type="text/javascript">
        function generate(total, skip, limit, filterTotal) {
            console.log('generating', total, skip, limit, filterTotal);
            total = 0 + total;
            skip = 0 + skip;
            limit = 0 + limit;
            var end = Math.min(skip + limit, total);
            console.log('total', skip, limit, end)

            var obj = {total:total, filterTotal:filterTotal || total, payload:[]}
            for (var i = skip; i < end; i++) {
                obj.payload.push('<li>Example Item ' + i + '</li>');
            }
            return obj;
        }
        define('jquery-paginate', ['jquery'], function ($) {
            var Paginate = function (element, options) {
                this.options = $.extend({}, $.fn.paginate.defaults, options);

                this.$el = $('<div class="btn-toolbar"></div>')
                this.$message = $('<div class="message"></div>');
                this.$buttonGrp = $('<div class="btn-group"></div>');
                this.$buttonGrp2 = $('<div class="btn-group"></div>');
                this.$buttonGrp3 = $('<div class="btn-group"></div>');
                this.$el.append(this.$buttonGrp, this.$buttonGrp2, this.$buttonGrp3);
                this.$el.delegate('.btn-group a.btn', 'click', $.proxy(this.onClick, this));
                this.$element = $(element).append(this.$message, this.$el);
                if (this.options.total) {
                    this.drawButtons();
                }

            }
            Paginate.prototype = {
                constructor:Paginate,
                onClick:function (e) {
                    var limit = this.options.limit;
                    var $c = $(e.currentTarget)
                    var page = $c.attr('data-page');
                    console.log('onClick', page);
                    $('.btn-primary', this.$el).removeClass('btn-primary');
                    this.options.skip = limit * (page - 1) + 1;
                    this.drawButtons();
                    this.makeRequest();

                },
                update:function (total, limit, skip, filterTotal) {
                    console.log('arguments', arguments);
                    total = total.total || total;
                    skip = skip || total.skip;
                    limit = limit || total.limit;
                    filterTotal = filterTotal || total.filterTotal;

                    if (typeof skip !== 'undefined')
                        this.options.skip = skip;
                    if (typeof limit !== 'undefined')
                        this.options.limit = limit;
                    if (typeof total !== 'undefined')
                        this.options.total = total;
                    if (typeof filterTotal !== 'undefined')
                        this.options.filterTotal = filterTotal;
                    console.log('update', this.options);
                    this.drawButtons();
                },
                drawButtons:function () {
                    this.$buttonGrp.empty();
                    this.$buttonGrp2.empty()
                    this.$buttonGrp3.empty();
                    var total = parseInt(this.options.total), limit = parseInt(this.options.limit), skip = parseInt(this.options.skip);
                    var pageCount = Math.ceil(total / limit);
                    var curpage = skip && Math.ceil(skip / limit) || 1;
                    console.log('skip', skip, 'curpage', curpage)
                    var btnTotal = 0;
                    for (var i = 1, l = Math.min(pageCount, 4); i <= l; i++) {
                        this.drawButton(this.$buttonGrp, i, i, curpage == i);
                        btnTotal = i;
                    }
                    var end = pageCount - 4;
                    if (pageCount > 4) {
                        if (pageCount > 7) {
                            var $bg = this.$buttonGrp2;
                            var cpath = curpage - 1 <= 4 ? Math.ceil(total / (limit * 2)) : curpage - 1;
                            for (var i = cpath; i < cpath + 3; i++) {
                                this.drawButton($bg, i, i, curpage == i);
                            }
                        }
                        var $bg = this.$buttonGrp3;
                        for (var i = end + 1; i <= pageCount; i++) {
                            this.drawButton($bg, i, i, curpage == i);
                        }
                    }
                },
                drawButton:function ($bg, content, page, select) {
                    var $btn = $(this.options.btnTemplate).html(content);
                    if (select)
                        $btn.addClass('btn-primary')
                    $btn.attr('data-page', page);
                    $bg.append($btn)
                    return $bg;
                },
                makeRequest:function () {
                    this.$element.trigger({type:'paginate-change', limit:parseInt(this.options.limit), skip:parseInt(this.options.skip - 1)});
                    this.load({limit:this.options.limit, skip:this.options.skip})
                },
                load:function (request) {
                    request.success = this.options.success;
                    request.error = this.options.error;
                    this.options.load(request)
                }
            };

            $.fn.paginate = function (option, args) {
                return this.each(function (s) {
                    var $this = $(this)
                            , data = $this.data('paginate')
                            , options = typeof option == 'object' && option || {skip:$this.attr('data-skip'), limit:$this.attr('data-limit'), total:$this.attr('data-total'), filterTotal:$this.attr('data-filter-total')};
                    if (!data) $this.data('paginate', (data = new Paginate(this, options)))
                    if (typeof option == 'string') data[option](args);
                    return data;
                })
            }

            $.fn.paginate.defaults = {
                limit:10,
                skip:0,
                btnTemplate:'<a class="btn"></a>',
                load:function (obj) {

                },
                onNext:function () {

                },
                onPrev:function () {

                },
                onPage:function (num) {

                },
                success:function () {

                },
                error:function (err) {

                }
            }

            $.fn.paginate.Constructor = Paginate;

            return $;
        });
        require(['jquery-paginate'], function ($) {
            $(function () {
                var $el = $('ul.page_content').empty();
//                $el.append.apply($el, generate(100, 10, 10, 20).payload);
                $('.paginate').paginate();
                var $li = $('#list');
                $('#listPage').paginate().on('paginate-change', function (event) {
                    var resp = generate(10000 * Math.random(), event.skip, event.limit);
                    console.log('response', resp, this);
                    $(this).paginate('update', resp);
                    $li.empty().append.apply($li, resp.payload);
                });
            });
        });

    </script>

</head>
<body>
<div class="paginate page_navigation span12" data-total="103" data-skip="22" data-limit="10"></div>
<div class="paginate page_navigation span12" data-total="103" data-skip="51" data-limit="10"></div>
<div class="paginate page_navigation span12" data-total="133" data-skip="61" data-limit="10"></div>
<div class="paginate page_navigation span12" data-total="1330" data-skip="651" data-limit="10"></div>
<div class="paginate page_navigation span12" data-total="1330" data-skip="1329" data-limit="10"></div>
<div class="paginate page_navigation span12" data-total="1330" data-skip="1319" data-limit="10"></div>
<div class="paginate page_navigation span12" data-total="1" data-skip="22" data-limit="10"></div>
<div class="paginate page_navigation span12" data-total="0" data-skip="22" data-limit="10"></div>
<div id="listPage" class="paginate page_navigation span12" data-total="2220" data-skip="22" data-limit="10"></div>
<ul id="list">

</ul>
</body>
</html>